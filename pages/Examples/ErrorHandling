<html>
<head>
<title>Error Handling Example :: Ratchet Lua Library</title>
<link type="text/css" rel="stylesheet" href="/css/ratchet_lua.css"/>
<link type="text/css" rel="stylesheet" href="/css/main.css"/>
</head>
<body>
<div class="floating-top-bar">
<div class="top-bar-left"><a href="/">Home</a></div>
<div class="top-bar-middle">Ratchet Library :: Error Handling Example</div>
<div class="top-bar-right">
<a href="/api/latest">API</a>
&nbsp;<b>&middot;</b>&nbsp;
<a href="/pages/TOC">Manual</a>
</div>
</div>
<div class="content">
<table class="content-table" align=left>
<tr>
<td width=150> </td>
<td>
<h2>Error Handling</h2>
<div class="ratchet_lua"><pre><span class="nb">require</span> <span class="s2">&quot;</span><span class="s">ratchet&quot;</span>

<span class="k">function</span> <span class="nf">ctx1</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">ratchet</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="n">prepare_tcp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">ratchet</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">family</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">socktype</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span>
    <span class="n">socket</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>

    <span class="kd">local</span> <span class="n">worked</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="nb">pcall</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">connect</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span><span class="p">:</span><span class="n">is</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ETIMEDOUT&quot;</span><span class="p">)</span> <span class="k">then</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Log: connection to &quot;</span><span class="o">..</span><span class="n">host</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">:&quot;</span><span class="o">..</span><span class="n">port</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> timed out.&quot;</span><span class="p">)</span>
    <span class="k">elseif</span> <span class="n">err</span><span class="p">:</span><span class="n">is</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ECONNREFUSED&quot;</span><span class="p">)</span> <span class="k">then</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Log: connection to &quot;</span><span class="o">..</span><span class="n">host</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">:&quot;</span><span class="o">..</span><span class="n">port</span><span class="o">..</span><span class="s2">&quot;</span><span class="s"> refused.&quot;</span><span class="p">)</span>
    <span class="k">elseif</span> <span class="ow">not</span> <span class="n">worked</span> <span class="k">then</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Log: connection failed: &quot;</span><span class="o">..</span><span class="nb">tostring</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">kernel</span> <span class="o">=</span> <span class="n">ratchet</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span>
    <span class="n">ratchet</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">ctx1</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">localhost&quot;</span><span class="p">,</span> <span class="mi">10025</span><span class="p">)</span>
<span class="k">end</span><span class="p">)</span>
<span class="n">kernel</span><span class="p">:</span><span class="n">loop</span><span class="p">()</span>
</pre></div>
<p><br/>
&nbsp;</p>
<div class="ratchet_lua"><pre><span class="nb">require</span> <span class="s2">&quot;</span><span class="s">ratchet&quot;</span>

<span class="k">function</span> <span class="nf">ctx1</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">rec</span> <span class="o">=</span> <span class="n">ratchet</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="n">prepare_tcp</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="kd">local</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">ratchet</span><span class="p">.</span><span class="n">socket</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">family</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">socktype</span><span class="p">,</span> <span class="n">rec</span><span class="p">.</span><span class="n">protocol</span><span class="p">)</span>
    <span class="n">socket</span><span class="p">:</span><span class="n">set_timeout</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>

    <span class="n">socket</span><span class="p">:</span><span class="n">connect</span><span class="p">(</span><span class="n">rec</span><span class="p">.</span><span class="n">addr</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">error_handler</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="n">thread</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="s2">&quot;</span><span class="s">ratchet_error&quot;</span> <span class="k">then</span>
        <span class="k">if</span> <span class="n">err</span><span class="p">:</span><span class="n">is</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ETIMEDOUT&quot;</span><span class="p">)</span> <span class="k">then</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Log: connection timed out.&quot;</span><span class="p">)</span>
        <span class="k">elseif</span> <span class="n">err</span><span class="p">:</span><span class="n">is</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">ECONNREFUSED&quot;</span><span class="p">)</span> <span class="k">then</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Log: connection refused.&quot;</span><span class="p">)</span>
        <span class="k">else</span>
            <span class="nb">print</span><span class="p">(</span><span class="nb">debug.traceback</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="nb">tostring</span><span class="p">(</span><span class="n">err</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
            <span class="nb">os.exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">end</span>
    <span class="k">else</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">debug.traceback</span><span class="p">(</span><span class="n">thread</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="nb">os.exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">end</span>
<span class="k">end</span>

<span class="n">kernel</span> <span class="o">=</span> <span class="n">ratchet</span><span class="p">.</span><span class="n">new</span><span class="p">(</span><span class="k">function</span> <span class="p">()</span>
    <span class="n">ratchet</span><span class="p">.</span><span class="n">thread</span><span class="p">.</span><span class="n">attach</span><span class="p">(</span><span class="n">ctx1</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">localhost&quot;</span><span class="p">,</span> <span class="mi">10025</span><span class="p">)</span>
<span class="k">end</span><span class="p">,</span> <span class="n">error_handler</span><span class="p">)</span>

<span class="n">kernel</span><span class="p">:</span><span class="n">loop</span><span class="p">()</span>
</pre></div> </td>
</tr>
<tr>
<td> </td>
<td colspan=2 align="center"><br/><br/>
<hr style="border: none; height:1px; color: black; background-color: black" width=200 />
<table cellspacing=0 cellpadding=0>
<tr>
<td align="right">
<font size=1>Last modified:&nbsp;</font>
</td>
<td align="left">
<font size=1><em>Sun, 17 Aug 2014 09:32:32 -0400</em></font>
</td>
</tr>
<tr>
<td align="right">
<font size=1>Author:&nbsp;</font>
</td>
<td align="left">
<font size=1><em>icgood</em></font>
</td>
</tr>
</table>
</td>
</tr>
</table>
</div>
</body>
</html>
